<!DOCTYPE html>
<html>
    <head>
        <title>London</title>
        <style>
            html, body, #map-canvas {
                height: 100%;
                margin: 0px;
                padding: 0px
            }
            #map-canvas {
                background:url(images/bg-body.gif) repeat #363D47;
            }
            #panel {
                position: absolute;
                top: 5px;
                left: 50%;
                margin-left: -180px;
                z-index: 5;
                padding: 5px;
                border: 1px solid #999;
            }
        </style>
    </head>
    </body>
    <div id="panel">
        <input onclick="getArrivals();" type=button value="Move Marker">
    </div>
    <div id="map-canvas"></div>
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script type="text/javascript">
        var colors = {
            'bakerloo' : '#AE6118',
            'central' : '#E41F1F',
            'circle' : '#F8D42D',
            'district' : '#007229',
            'hammersmith-city' : '#E899A8',
            'jubilee' : '#686E72',
            'metropolitan' : '#893267',
            'northern' : '#000000',
            'piccadilly' : '#0450A1',
            'victoria' : '#009FE0',
            'waterloo-city' : '#70C3CE'
        };
        var hiddenStyle = [{"featureType":"all","stylers":[{"visibility":"off"}]}];
        var myStyles = [{"featureType":"administrative","stylers":[{"visibility":"off"}]},{"featureType":"poi","stylers":[{"visibility":"off"}]},{"featureType":"landscape","stylers":[{"visibility":"off"}]},{"featureType":"transit","stylers":[{"visibility":"off"}]},{"featureType":"all","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},{"featureType":"transit.station.rail","stylers":[{"visibility":"on"}]},{"featureType":"road","stylers":[{"color":"#2f353f"}]},{"featureType":"all","elementType":"labels.text.fill","stylers":[{"color":"#eeeeee"}]},{"featureType":"all","elementType":"labels.text.stroke","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"labels.text.fill","stylers":[{"color":"#222222"}]},{"featureType":"road","elementType":"labels.text.stroke","stylers":[{"visibility":"off"}]},{"featureType":"administrative.neighborhood","elementType":"labels.text.fill","stylers":[{"visibility":"on"},{"color":"#999999"}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#2f353f"}]}];
        var myStyles2 = [{"featureType":"landscape.man_made","elementType":"geometry","stylers":[{"color":"#f7f1df"}]},{"featureType":"landscape.natural","elementType":"geometry","stylers":[{"color":"#d0e3b4"}]},{"featureType":"landscape.natural.terrain","elementType":"geometry","stylers":[{"visibility":"off"}]},{"featureType":"poi","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"poi.business","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi.medical","elementType":"geometry","stylers":[{"color":"#fbd3da"}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#bde6ab"}]},{"featureType":"road","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ffe15f"}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#efd151"}]},{"featureType":"road.arterial","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"road.local","elementType":"geometry.fill","stylers":[{"color":"black"}]},{"featureType":"transit.station.airport","elementType":"geometry.fill","stylers":[{"color":"#cfb2db"}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#a2daf2"}]}];


        var stnId = 'KSX';
        var station;
        var stations;
        function getStation() {
            var jqxhr;
            jqxhr = $.ajax( "data/stations.min.json").done(function (data) {
                stations = data;
                station = data[stnId];
            }).always(function() {
                loadMap(station['lat'],station['lon']);
            });
        }
        getStation();

        function loadMap(lat,lon) {
            var center = new google.maps.LatLng(lat, lon);
            var mapOptions = {
                zoom: 12,
                backgroundColor: '#000000',
                center: center,
                styles : myStyles2
            };
            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
            //var transitLayer = new google.maps.TransitLayer();
            //transitLayer.setMap(map);
            getArrivals();
        }

        var started = false;
        var gObj = {};
        function getArrivals() {
            var url = 'http://api.tfl.gov.uk/StopPoint/%7Bids%7D/Arrivals?ids=940GZZLU'+stnId;
            if (stnId) {
                //url = 'http://api.tfl.gov.uk/Line/%7Bids%7D/Arrivals?ids=bakerloo%2Ccentral%2Ccircle%2Cdistrict%2Chammersmith-city%2Cjubilee%2Cmetropolitan%2Cnorthern%2Cpiccadilly%2Cvictoria%2Cwaterloo-city';
                url = 'http://api.tfl.gov.uk/Line/%7Bids%7D/Arrivals?ids=central';
            }
            var mObj = {}
            var jqxhr = $.ajax(url).done(function (data) {
                for (var i=0; i<data.length; i++) {
                    var location;
                    var currentLocationStr = data[i]["currentLocation"];
                    if (currentLocationStr === 'At Platform') {
                        location = stnLookup(data[i]["stationName"].split(' Underground')[0]);
                    } else {
                        switch (currentLocationStr.substring(0,2)) {
                            case 'Be':
                                var stns = currentLocationStr.substring(8).split(' and ');
                                location = newLatLon(stnLookup(stns[0]), stnLookup(stns[1]), 0.5);
                                break;
                            default:
                                location = stnLookup(currentLocationStr);
                        }
                    }
                    if (isNaN(location['lat']) || isNaN(location['lon'])) {
                        continue;
                    }
                    var lineIdStr = data[i]['lineId'].substr(0,2);
                    var objId = lineIdStr+data[i]['vehicleId'];
                    var markerObj = {
                        id: objId,
                        data: data[i],
                        lat: location['lat'],
                        lon: location['lon'],
                        title: objId + ': ' + data[i]['lineName'] + ' line towards ' + data[i]['towards'] + '. ' + data[i]['currentLocation'],
                        color: colors[data[i]['lineId']]
                    };
                    mObj[objId] = markerObj;
                }
                if (!started) {
                    init(mObj);
                } else {
                    addMoveRemove(mObj);
                }
            });
        }
        function init (mObj) {
            for (var key in mObj) {
                addMarker(mObj[key]);
            }
            started = true;
        }
        function addMoveRemove(mObj) {
            for (var i in gObj) {
                var gObjId = gObj[i]['id'];
                if (mObj[gObjId]) {
                    if (gObj[i].position.A !== mObj[gObjId]['lat']) {
                        moveMarker(gObj[i], mObj[gObjId]['lat'], mObj[gObjId]['lon'], mObj[gObjId]['title']);
                    }
                } else {
                    gObj[i].setMap(null);
                    delete gObj[i];
                }
                delete mObj[gObjId];
            }
            for (var key in mObj) {
                addMarker(mObj[key]);
            }
        }
        function stnLookup(str) {
            var stn;
            for (stn in stations) {
                if (str.indexOf(stations[stn]["name"]) > -1) {
                    return stations[stn];
                }
            }
            return false;
        }
        function newLatLon(s1, s2, ratio) {
            var lat = s1['lat'] + ((s2['lat'] - s1['lat']) * ratio);
            var lon = s1['lon'] + ((s2['lon'] - s1['lon']) * ratio);
            return {
                'lat': lat,
                'lon': lon
            };
        }
        function addMarker(mObj) {
            var location = new google.maps.LatLng(mObj['lat'],mObj['lon']);
            marker = new google.maps.Marker({
                position: location,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 3,
                    fillOpacity: 1,
                    fillColor: mObj['color'],
                    strokeWeight:0
                },
                map: map,
                //animation: google.maps.Animation.DROP,
                title: mObj['title']
            });
            marker.id = mObj['id'];
            marker.mData = mObj['data'];
            gObj[mObj['id']] = marker;
            google.maps.event.addListener(marker, 'click', function() {
                console.log(this.mData);
            });
        }
        function moveMarker(gObj, lat, lon, title) {
            gObj.setPosition(new google.maps.LatLng(lat, lon));
            gObj.title = title;
        }
    </script>
    </body>
</html>