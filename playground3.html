<!DOCTYPE html>
<html>
    <head>
        <title>London</title>
        <style>
            html, body, #map-canvas {
                height: 100%;
                margin: 0px;
                padding: 0px
            }
            #map-canvas {
                background:url(images/bg-body.gif) repeat #363D47; 
            }
            #panel {
                position: absolute;
                top: 5px;
                left: 50%;
                margin-left: -180px;
                z-index: 5;
                padding: 5px;
                border: 1px solid #999;
            }
        </style>
    </head>
    </body>
    <div id="panel">
        <input onclick="clearMarkers();" type=button value="Hide Markers">
        <input onclick="showMarkers();" type=button value="Show All Markers">
        <input onclick="deleteMarkers();" type=button value="Delete Markers">
        <input onclick="getArrivals();" type=button value="Move Marker">
    </div>
    <div id="map-canvas"></div>
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script type="text/javascript">
        var colors = {
            'bakerloo' : '#AE6118',
            'central' : '#E41F1F',
            'circle' : '#F8D42D',
            'district' : '#007229',
            'hammersmith-city' : '#E899A8',
            'jubilee' : '#686E72',
            'metropolitan' : '#893267',
            'northern' : '#000000',
            'piccadilly' : '#0450A1',
            'victoria' : '#009FE0',
            'waterloo-city' : '#70C3CE'
        };
        var myStyles = [{"featureType":"administrative","stylers":[{"visibility":"off"}]},{"featureType":"poi","stylers":[{"visibility":"off"}]},{"featureType":"landscape","stylers":[{"visibility":"off"}]},{"featureType":"transit","stylers":[{"visibility":"off"}]},{"featureType":"all","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},{"featureType":"transit.station.rail","stylers":[{"visibility":"on"}]},{"featureType":"road","stylers":[{"color":"#2f353f"}]},{"featureType":"all","elementType":"labels.text.fill","stylers":[{"color":"#eeeeee"}]},{"featureType":"all","elementType":"labels.text.stroke","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"labels.text.fill","stylers":[{"color":"#222222"}]},{"featureType":"road","elementType":"labels.text.stroke","stylers":[{"visibility":"off"}]},{"featureType":"administrative.neighborhood","elementType":"labels.text.fill","stylers":[{"visibility":"on"},{"color":"#999999"}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#2f353f"}]}];

        var stnId = 'OXC';
        var station;
        var stations;
        var markers = {};
        var count = 1;
        function getStation() {
            var jqxhr;
            jqxhr = $.ajax( "data/stations.min.json").done(function (data) {
                stations = data;
                station = data[stnId];
            }).always(function() {
                loadMap(station['lat'],station['lon']);
            });
        }
        getStation();

        function loadMap(lat,lon) {
            var center = new google.maps.LatLng(lat, lon);
            var mapOptions = {
                zoom: 15,
                center: center,
                styles : myStyles
            };
            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
            var transitLayer = new google.maps.TransitLayer();
            transitLayer.setMap(map);
            getArrivals();
        }

        function getArrivals() {
            var url = 'http://api.tfl.gov.uk/StopPoint/%7Bids%7D/Arrivals?ids=940GZZLU'+stnId;
            if (!stnId) {
                url = 'http://api.tfl.gov.uk/Line/%7Bids%7D/Arrivals?ids=bakerloo%2Ccentral%2Ccircle%2Cdistrict%2Chammersmith-city%2Cjubilee%2Cmetropolitan%2Cnorthern%2Cpiccadilly%2Cvictoria%2Cwaterloo-city';
            }
            var jqxhr = $.ajax(url).done(function (data) {
                for (var i=0; i<data.length; i++) {
                    var location;
                    var currentLocationStr = data[i]["currentLocation"];
                    if (currentLocationStr === 'At Platform') {
                        location = stnLookup(data[i]["stationName"].split(' Underground')[0]);
                    } else {
                        switch (currentLocationStr.substring(0,2)) {
                            case 'Be':
                                var stns = currentLocationStr.substring(8).split(' and ');
                                location = newLatLon(stnLookup(stns[0]), stnLookup(stns[1]), 0.5);
                                break;
                            default:
                                location = stnLookup(currentLocationStr);
                        }
                    }
                    var markerObj = {
                        id: data[i]['vehicleId'],
                        data: data[i],
                        lat: location['lat'],
                        lon: location['lon'],
                        title: data[i]['vehicleId'] + ': ' + data[i]['lineName'] + ' line towards ' + data[i]['towards'] + '. ' + data[i]['currentLocation'],
                        color: colors[data[i]['lineId']],
                        status: null
                    };
                    if (!markers[data[i]['vehicleId']]) {
                        markerObj['status'] = 'new';
                    }
                    if (markers[data[i]['vehicleId']]) {
                        markerObj['status'] = 'move';
                    }
                    markers[data[i]['vehicleId']] = markerObj;
                }
                placeMarkers();
                count++;
            });
        }
        function stnLookup(str) {
            var stn;
            for (stn in stations) {
                if (str.indexOf(stations[stn]["name"]) > -1) {
                    return stations[stn];
                }
            }
            return false;
        }
        function newLatLon(s1, s2, ratio) {
            var lat = s1['lat'] + ((s2['lat'] - s1['lat']) * ratio);
            var lon = s1['lon'] + ((s2['lon'] - s1['lon']) * ratio);
            return {
                'lat': lat,
                'lon': lon
            };
        }
        function placeMarkers() {
            for (var key in markers) {
                var location = new google.maps.LatLng(markers[key]['lat'],markers[key]['lon']);
                markers[key] = new google.maps.Marker({
                    position: location,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillOpacity: 1,
                        fillColor: markers[key]['color'],
                        strokeColor: '#202020',
                        strokeWeight:1
                    },
                    map: map,
                    title: markers[key]['title']
                });
                markers[key].setMap(map);
            }
        }

        //google.maps.event.addDomListener(window, 'load', getStation('OXC'));
    </script>
    </body>
</html>