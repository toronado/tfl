<!DOCTYPE html>
<html>
    <head>
        <title>London</title>
    </head>
    </body>
        <button onClick="logData();">Log</button>
        <script src="js/jquery-2.1.3.min.js"></script>
        <script src="data/stations.min.js"></script>
        <script type="text/javascript">
            
            var endPoints = {
                'bakerloo': ['HAW','EAC'],
                'central': ['HLT','EPG','EBY','WRP'],
                'circle': ['HSC'],
                'district': ['UPM','RMD','WIM','ERC','KOY'],
                'hammersmith-city': ['HSC','BKG'],
                'jubilee': ['STM','STD'],
                'metropolitan': ['ALD','UXB','CSM','AMS'],
                'northern': ['MDN','HBT','EGW','MHL'],
                'piccadilly': ['CKS','UXB','HR5'],
                'victoria': ['WWL','BXN'],
                'waterloo-city': ['BNK','WLO']
            };
            var stnObj = {};

            for (var line in endPoints) {
                for (var stn in endPoints[line]) {
                    $.ajax({
                        url: 'https://api.tfl.gov.uk/Line/%7Bid%7D/Timetable/%7BfromStopPointId%7D',
                        type: 'GET',
                        data: { 
                            fromStopPointId: "940GZZLU"+endPoints[line][stn],
                            id : line
                        }
                    }).done(function (data) {
                        var dataArr = data.timetable.routes[0].stationIntervals;
                        for (var i=0; i<dataArr.length; i++) {
                            doit(dataArr[i].intervals);
                        }
                    });
                }
            }

            function doit(json) {
                var i;
                var jsonLen = json.length;

                for (i = 0; i < jsonLen; i++) {

                    var sid = json[i]['stopId'].substring(8);
                    var tti = json[i]['timeToArrival'];

                    if (!stnObj[sid]) {
                        stnObj[sid] = {};
                    }
                    
                    if (i) {
                        var ttn = Math.round((tti - json[i-1]['timeToArrival']) * 60);
                        var ttc = stnObj[sid][json[i-1]['stopId'].substring(8)];
                        if (ttc) {
                            stnObj[sid][json[i-1]['stopId'].substring(8)] = Math.round((ttn+ttc)/2);
                        } else {
                            stnObj[sid][json[i-1]['stopId'].substring(8)] = ttn;
                        }
                    }

                    if (i < jsonLen-1) {
                        var ttp = Math.round((json[i+1]['timeToArrival'] - tti) * 60);
                        var ttc2 = stnObj[sid][json[i+1]['stopId'].substring(8)];
                        if (ttc2) {
                            stnObj[sid][json[i+1]['stopId'].substring(8)] = Math.round((ttp+ttc2)/2);
                        } else {
                            stnObj[sid][json[i+1]['stopId'].substring(8)] = ttp;
                        }
                    }
                }
            }
            function logData() {
                var i=0;
                for (var key in stnObj) {
                    i++;
                }
                console.log(i);
                console.log(stnObj);
            }
        </script>
    </body>
</html>