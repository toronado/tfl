<!DOCTYPE html>
<html>
    <head>
        <title>London</title>
    </head>
    </body>
        <button onclick="getLiveData()">Get Live</button>
        <button onclick="logData()">Log</button>
        <button onclick="createLookup()">Any</button>
        <script src="js/jquery-2.1.3.min.js"></script>
        <script src="data/stationsObj.min.js"></script>
        <script type="text/javascript">
            
            //var stationsObj = stationsObj.min.js
            var stnObj = {};
            var endPoints = {
                'central': ['HLT','EPG','EBY','WRP'],
                'bakerloo': ['HAW','EAC'],
                'central': ['HLT','EPG','EBY','WRP'],
                'circle': ['HSC'],
                'district': ['UPM','RMD','WIM','ERC','KOY'],
                'hammersmith-city': ['HSC','BKG'],
                'jubilee': ['STM','STD'],
                'metropolitan': ['ALD','UXB','CSM','AMS'],
                'northern': ['MDN','HBT','EGW','MHL'],
                'piccadilly': ['CKS','UXB','HR5'],
                'victoria': ['WWL','BXN'],
                'waterloo-city': ['BNK','WLO']
            };
            var startPoints = {
                'central': {
                    'inbound': ['HLT','EPG'],
                    'outbound': ['EBY','WRP']
                },
                'bakerloo': {
                    'inbound': ['HAW'],
                    'outbound': ['EAC']
                },
                'district': {
                    'inbound': ['UPM','ERC'],
                    'outbound': ['RMD','WIM','KOY']
                },
                'hammersmith-city': {
                    'inbound': ['BKG'],
                    'outbound': ['HSC','BKG']
                },
                'jubilee': {
                    'inbound': ['STD'],
                    'outbound': ['STM']
                },
                'metropolitan': {
                    'inbound': ['ALD'],
                    'outbound': ['UXB','CSM','AMS']
                },
                'northern': {
                    'inbound': ['HBT','EGW','MHL'],
                    'outbound': ['MDN']
                },
                'piccadilly': {
                    'inbound': ['CKS'],
                    'outbound': ['UXB','HR5']
                },
                'victoria': {
                    'inbound': ['WWL'],
                    'outbound': ['BXN']
                },
                'waterloo-city': {
                    'inbound': ['BNK'],
                    'outbound': ['WLO']
                },
                'circle': {
                    'outbound': ['HSC']
                }
            };

            var lookup = {};

            function createLookup() {
                for (var station in stationsObj) {
                    if (!stationsObj[station]['id']) {
                        //stationsObj[station]['id'] = station;
                        console.log('oh noe');
                    }
                    lookup[stationsObj[station]['name']] = stationsObj[station]['id'];
                }
                console.log(lookup);
                
            }

            function mergeData() {
                for (var key in routeObj) {
                    for (var adj in routeObj[key]) {
                        if (!stationsObj[key]['route']) {
                            stationsObj[key]['route'] = {};
                        }
                        stationsObj[key]['route'][adj] = key;
                    } 
                }
                console.log(stationsObj);
            }

            function getLiveData() {
                var line, sid;

                for (line in endPoints) {
                    for (sid in endPoints[line]) {
                        $.ajax({
                            url: 'https://api.tfl.gov.uk/Line/%7Bid%7D/Timetable/%7BfromStopPointId%7D',
                            type: 'GET',
                            data: { 
                                fromStopPointId: "940GZZLU"+endPoints[line][sid],
                                id: line
                            }
                        }).done(function (data) {
                            var i;
                            var dataArr = data.timetable.routes[0].stationIntervals;
                            var dataLen = dataArr.length;
                            for (i=0; i<dataLen; i++) {
                                process(dataArr[i].intervals);
                            }
                        });
                    }
                }
            }

            function process(data) {

                var dataLen = data.length;
                var i,
                    sid, // This station id
                    pid, // Previous station id
                    nid, // Next station id
                    ttp, // Time to previous station
                    ttn; // Time to next station

                for (i = 0; i < dataLen; i++) {

                    sid = data[i]['stopId'].substring(8);
                   
                    // Check if station exists in station object. If not, create it.
                    if (!stnObj[sid]) {
                        stnObj[sid] = {};
                    }

                    // Has a previous station
                    if (i) {
                        pid = data[i-1]['stopId'].substring(8);
                        ttp = Math.round((data[i]['timeToArrival']-data[i-1]['timeToArrival'])*10)/10;
                        if (stnObj[sid][pid]) {
                            stnObj[sid][pid].push(ttp);
                        } else {
                            stnObj[sid][pid] = [ttp];
                        }
                    }

                    // Has a next station
                    if (i < dataLen-1) {
                        nid = data[i+1]['stopId'].substring(8);
                        ttn = Math.round((data[i+1]['timeToArrival']-data[i]['timeToArrival'])*10)/10;
                        if (stnObj[sid][nid]) {
                            stnObj[sid][nid].push(ttn);
                        } else {
                            stnObj[sid][nid] = [ttn];
                        }
                    }

                }
            }

            function logData() {
                var i, stn, adj, total;
                for (stn in stnObj) {
                    for (adj in stnObj[stn]) {
                        total = 0;
                        var adjLen = stnObj[stn][adj].length;
                        for (i=0; i<adjLen; i++) {
                            total += stnObj[stn][adj][i];
                        }
                        stnObj[stn][adj] = Math.round((total/adjLen)*60);
                    }
                }
                console.log(stnObj);
            }
        </script>
    </body>
</html>