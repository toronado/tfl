<!DOCTYPE html>
<html>
    <head>
        <title>London</title>
    </head>
    </body>
        <button onClick="logData();">Log</button>
        <script src="js/jquery-2.1.3.min.js"></script>
        <script src="data/stations.min.js"></script>
        <script type="text/javascript">
            
            var endPoints = {
                'central': ['HLT','EPG','EBY','WRP'],
                'bakerloo': ['HAW','EAC'],
                'central': ['HLT','EPG','EBY','WRP'],
                'circle': ['HSC'],
                'district': ['UPM','RMD','WIM','ERC','KOY'],
                'hammersmith-city': ['HSC','BKG'],
                'jubilee': ['STM','STD'],
                'metropolitan': ['ALD','UXB','CSM','AMS'],
                'northern': ['MDN','HBT','EGW','MHL'],
                'piccadilly': ['CKS','UXB','HR5'],
                'victoria': ['WWL','BXN'],
                'waterloo-city': ['BNK','WLO']
            };
            var stnObj = {};

            for (var line in endPoints) {
                for (var stn in endPoints[line]) {
                    $.ajax({
                        url: 'https://api.tfl.gov.uk/Line/%7Bid%7D/Timetable/%7BfromStopPointId%7D',
                        type: 'GET',
                        data: { 
                            fromStopPointId: "940GZZLU"+endPoints[line][stn],
                            id: line
                        }
                    }).done(function (data) {
                        var dataArr = data.timetable.routes[0].stationIntervals;
                        for (var i=0; i<dataArr.length; i++) {
                            doit(dataArr[i].intervals);
                        }
                    });
                }
            }

            function doit(data) {
                var i;
                var dataLen = data.length;
                for (i = 0; i < dataLen; i++) {

                    var stid = data[i]['stopId'].substring(8);
                   
                    if (!stnObj[stid]) {
                        stnObj[stid] = {};
                    }
                    //has a previous station
                    if (i > 0) {
                        var prev = data[i-1]['stopId'].substring(8);
                        var time = Math.round((data[i]['timeToArrival']-data[i-1]['timeToArrival'])*10)/10;
                        if (stnObj[stid][prev]) {
                            stnObj[stid][prev].push(time);
                        } else {
                            stnObj[stid][prev] = [time];
                        }
                    }
                    // has a next station
                    if (i < dataLen-1) {
                        var next = data[i+1]['stopId'].substring(8);
                        var time = Math.round((data[i+1]['timeToArrival']-data[i]['timeToArrival'])*10)/10;
                        if (stnObj[stid][next]) {
                            stnObj[stid][next].push(time);
                        } else {
                            stnObj[stid][next] = [time];
                        }
                    }
                }
            }

            function logData() {
                for (var stn in stnObj) {
                    for (var adj in stnObj[stn]) {
                        var count = 0;
                        var adjLen = stnObj[stn][adj].length;
                        for (var i=0; i<adjLen; i++) {
                            count += stnObj[stn][adj][i];
                        }
                        stnObj[stn][adj] = Math.round((count/adjLen)*60);
                    }
                }
                console.log(stnObj);
            }
        </script>
    </body>
</html>